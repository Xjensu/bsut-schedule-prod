<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>

<style>
/* Reset & Basic Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: "SF Pro Text", "Myriad Set Pro", "SF Pro Icons", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
    background-color: #ffffff;
    color: #1d1d1f;
    overflow-x: hidden;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
}

#webgl-canvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
}

/* Main Content Wrapper */
.main-content-wrapper {
    padding-top: 80px;
    padding-bottom: 40px;
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 100%;
}

.container {
    width: 100%;
    max-width: 1200px;
    text-align: center;
    position: relative;
    padding: 0 20px;
}

.top-right {
    position: absolute;
    top: 6rem;
    right: 2rem;
    font-size: 1rem;
    letter-spacing: 2px;
    color: #86868b;
}

.content {
    display: flex;
    align-items: start;
    justify-content: center;
    position: relative;
    margin-top: 2rem;
}

.group-content {
    display: flex;
    align-items: start;
    justify-content: left;
    position: relative;
}

/* Arrow for group */
.arrow-line {
    position: absolute;
    width: 150px;
    height: 1px;
    background-color: #1d1d1f;
    transition: top 0.4s ease;
}

.arrow-line::after {
    content: '';
    position: absolute;
    right: -15px;
    top: -7px;
    width: 0;
    height: 0;
    border-left: 15px solid #1d1d1f;
    border-top: 7px solid transparent;
    border-bottom: 7px solid transparent;
}

.text-container {
    text-align: left;
    margin-left: 180px;
    position: relative;
}

.subtitle {
    font-size: 0.875rem;
    letter-spacing: 1px;
    margin-bottom: 0.5rem;
    color: #86868b;
}

.title-parts {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    position: relative;
}

.title-part {
    font-size: 5rem;
    font-weight: 300;
    line-height: 1.2;
    margin: 0;
    color: #d2d2d7;
    cursor: pointer;
    transition: color 0.3s ease;
}

.title-part.active {
    color: #1d1d1f;
}

.title-part:hover {
    color: #86868b;
}

/* --- Course Section --- */
.selection-section {
    text-align: center;
    position: relative;
}

.selection-subtitle {
    font-size: 1.5rem;
    margin-top: 4rem;
    letter-spacing: 1px;
    margin-bottom: 2rem;
    color: #1d1d1f;
}

.numbers-container {
    display: flex;
    justify-content: center;
    gap: 2rem;
    position: relative;
}

.number {
    font-size: 3rem;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #d2d2d7;
    cursor: pointer;
    transition: color 0.3s ease;
}

.number.active {
    color: #1d1d1f;
}

.number:hover {
    color: #86868b;
}

/* Arrow under selected course */
.course-arrow {
    position: absolute;
    top: 75px;
    left: 0;
    width: 0;
    height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 15px solid #1d1d1f;
    transition: left 0.4s ease;
}

.scroll-indicator {
    margin-top: 4rem;
    text-align: center;
    width: 100%;
    padding: 0 2rem;
}

.horizontal-line {
    width: 100%;
    height: 1px;
    background-color: #d2d2d7;
    margin: 1rem 0;
}

.buttons-container {
    display: flex;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
    margin-bottom: 4rem;
    flex-direction: column;
    align-items: center;
}

.schedule-form {
    width: 100%;
    max-width: 320px;
}

.button {
    background-color: transparent;
    color: #1d1d1f;
    border: 1px solid #1d1d1f;
    border-radius: 10px;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    max-width: 320px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: block;
    text-decoration: none;
    text-align: center;
}

.button:hover {
    background-color: #1d1d1f;
    color: #fff;
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .title-part {
        font-size: 3rem;
    }
    
    .text-container {
        margin-left: 100px;
    }
    
    .arrow-line {
        width: 80px;
    }
    
    .numbers-container {
        gap: 1rem;
    }
    
    .number {
        font-size: 2rem;
        width: 40px;
        height: 40px;
    }
}
</style>

<canvas id="webgl-canvas"></canvas>

<div class="main-content-wrapper">
    <div class="top-right"><%= @short_name %></div>

    <div class="container">
        <% if @groups.present? %>
            <div class="selection-subtitle">Выберите группу</div>
            <div class="content">
                <div class="group-content">
                    <div class="arrow-line"></div>
                    <div class="text-container">
                        <div class="title-parts">
                            <% @groups.each do |group| %>
                                <div class="title-part <%= 'active' if group.id == @selected_group_id %>" 
                                     data-group-id="<%= group.id %>">
                                    <%= group.group_name %>
                                </div>
                            <% end %>
                        </div>
                    </div>
                </div>
            </div>

            <div class="selection-section">
                <div class="selection-subtitle">Выберите курс</div>
                <div class="numbers-container">
                    <% (1..5).each do |course| %>
                        <div class="number <%= 'active' if course == @selected_course.to_i %>" 
                             data-course="<%= course %>">
                            <%= course %>
                        </div>
                    <% end %>
                    <div class="course-arrow"></div>
                </div>
            </div>

            <div class="scroll-indicator"><div class="horizontal-line"></div></div>

            <div class="buttons-container">
                <%= form_with url: student_schedule_index_path, method: :get, local: true, class: "schedule-form", data: { turbo: false } do |form| %>
                    <%= form.hidden_field :group_id, class: "form-group-id", value: @selected_group_id %>
                    <%= form.hidden_field :course, class: "form-course", value: @selected_course %>
                    <%= form.submit "Основное расписание", class: "button" %>
                <% end %>

                <%= form_with url: download_student_schedule_path, method: :get, local: true, class: "schedule-form", data: { turbo: false } do |form| %>
                    <%= form.hidden_field :group_id, class: "form-group-id", value: @selected_group_id %>
                    <%= form.hidden_field :course, class: "form-course", value: @selected_course %>
                    <%= form.submit "Скачать расписание", class: "button" %>
                <% end %>

                <%= form_with url: student_schedule_index_path, method: :get, local: true, class: "schedule-form", data: { turbo: false } do |form| %>
                    <%= form.hidden_field :group_id, class: "form-group-id", value: @selected_group_id %>
                    <%= form.hidden_field :course, class: "form-course", value: @selected_course %>
                    <%= form.hidden_field :schedule_type, value: "lecture" %>
                    <%= form.submit "Лекционная неделя", class: "button" %>
                <% end %>

                <%= form_with url: student_schedule_index_path, method: :get, local: true, class: "schedule-form", data: { turbo: false } do |form| %>
                    <%= form.hidden_field :group_id, class: "form-group-id", value: @selected_group_id %>
                    <%= form.hidden_field :course, class: "form-course", value: @selected_course %>
                    <%= form.hidden_field :schedule_type, value: "test" %>
                    <%= form.submit "Зачеты", class: "button" %>
                <% end %>

                <%= form_with url: student_schedule_index_path, method: :get, local: true, class: "schedule-form", data: { turbo: false } do |form| %>
                    <%= form.hidden_field :group_id, class: "form-group-id", value: @selected_group_id %>
                    <%= form.hidden_field :course, class: "form-course", value: @selected_course %>
                    <%= form.hidden_field :schedule_type, value: "exam" %>
                    <%= form.submit "Экзамены", class: "button" %>
                <% end %>
            </div>
        <% else %>
            <div class="mt-4" style="color: #86868b;">Нет данных о группах.</div>
        <% end %>
    </div>
</div>

<script>
(function() {
    // --- Background Animation ---
    function RoundedRectGeometry(width, height, radius) {
        const shape = new THREE.Shape();
        const x = -width / 2, y = -height / 2;
        shape.moveTo(x, y + radius);
        shape.lineTo(x, y + height - radius);
        shape.quadraticCurveTo(x, y + height, x + radius, y + height);
        shape.lineTo(x + width - radius, y + height);
        shape.quadraticCurveTo(x + width, y, x + width, y + height - radius);
        shape.lineTo(x + width, y + radius);
        shape.quadraticCurveTo(x + width, y, x + width - radius, y);
        shape.lineTo(x + radius, y);
        shape.quadraticCurveTo(x, y, x, y + radius);
        return new THREE.ShapeGeometry(shape);
    }

    const Engine = Matter.Engine,
        World = Matter.World,
        Bodies = Matter.Bodies,
        Body = Matter.Body;

    let camera, scene, renderer;
    let particles = []; 

    let engine, world;
    let walls = [];

    const PARTICLE_COUNT = 80; 
    const PARTICLE_BASE_SIZE = 4;
    const PHYSICS_RADIUS_MULTIPLIER = 0.5; 
    const PHYSICS_RADIUS = PARTICLE_BASE_SIZE * PHYSICS_RADIUS_MULTIPLIER; 

    const PARTICLE_COLOR = 0x8ab4f8; 

    const ATTRACTION_RADIUS = 350; 
    const ORBIT_RADIUS = 120; 
    const FORCE_STRENGTH = 0.00005; 

    const PULSE_SPEED = 0.003;
    const PULSE_AMPLITUDE = 0.2; 

    let mouse = new THREE.Vector2(-9999, -9999);
    let mouseLight; 

    function init() {
        const canvas = document.getElementById('webgl-canvas');
        if (!canvas) return;

        if (renderer) renderer.dispose();
        if (engine) Matter.Engine.clear(engine);

        engine = Engine.create();
        world = engine.world;
        engine.world.gravity.y = 0; 

        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff); 
        
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
        dirLight.position.set(10, 20, 10);
        scene.add(dirLight);

        mouseLight = new THREE.PointLight(PARTICLE_COLOR, 1.5, 600);
        mouseLight.position.set(0, 0, 100);
        scene.add(mouseLight);

        camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.z = 400;

        renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        resize();

        createWalls();
        createParticles();

        document.addEventListener('mousemove', onMouseMove, false);
        document.addEventListener('mouseleave', () => { 
            mouse.set(-9999, -9999); 
            if(mouseLight) mouseLight.intensity = 0; 
        });
        window.addEventListener('resize', resize, false);

        animate();
    }

    function createWalls() {
        if (walls.length > 0) World.remove(world, walls);
        
        const vFOV = THREE.MathUtils.degToRad(camera.fov);
        const height = 2 * Math.tan(vFOV / 2) * camera.position.z;
        const width = height * camera.aspect;
        const wallThickness = 100;

        walls = [
            Bodies.rectangle(0, -height/2 - wallThickness/2, width + wallThickness*2, wallThickness, { isStatic: true, restitution: 0.8 }), 
            Bodies.rectangle(0, height/2 + wallThickness/2, width + wallThickness*2, wallThickness, { isStatic: true, restitution: 0.8 }), 
            Bodies.rectangle(width/2 + wallThickness/2, 0, wallThickness, height + wallThickness*2, { isStatic: true, restitution: 0.8 }), 
            Bodies.rectangle(-width/2 - wallThickness/2, 0, wallThickness, height + wallThickness*2, { isStatic: true, restitution: 0.8 }) 
        ];
        World.add(world, walls);
    }

    function createParticles() {
        const geometry = RoundedRectGeometry(1, 0.6, 0.25); 
        const material = new THREE.MeshBasicMaterial({ color: PARTICLE_COLOR, transparent: true, opacity: 0.4, side: THREE.DoubleSide });
        
        const spawnRange = window.innerWidth / 3;

        particles.forEach(p => {
            scene.remove(p.mesh);
            World.remove(world, p.body);
        });
        particles = [];


        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const mesh = new THREE.Mesh(geometry, material.clone());
            const baseScale = PARTICLE_BASE_SIZE * (0.8 + Math.random() * 0.4);
            mesh.scale.set(baseScale, baseScale, baseScale);
            scene.add(mesh);

            const startX = (Math.random() - 0.5) * spawnRange;
            const startY = (Math.random() - 0.5) * spawnRange;

            const body = Bodies.circle(startX, startY, PHYSICS_RADIUS * baseScale, {
                friction: 0,
                frictionAir: 0.05, 
                restitution: 0.5 
            });
            
            Body.setAngle(body, Math.random() * Math.PI * 2);
            Body.setVelocity(body, { x: (Math.random()-0.5)*2, y: (Math.random()-0.5)*2 });
            
            World.add(world, body);

            particles.push({ mesh, body, baseScale });
        }
    }

    function onMouseMove(event) {
        const vec = new THREE.Vector3(
            (event.clientX / window.innerWidth) * 2 - 1,
            -(event.clientY / window.innerHeight) * 2 + 1,
            0.5
        );
        vec.unproject(camera);
        vec.sub(camera.position).normalize();
        const distance = -camera.position.z / vec.z;
        const pos = camera.position.clone().add(vec.multiplyScalar(distance));
        mouse.set(pos.x, pos.y);
    }

    function resize() {
        if (!camera || !renderer) return;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
        createWalls();
    }

    function animate() {
        requestAnimationFrame(animate);
        if (!engine || !scene || !camera || !renderer) return;

        Engine.update(engine, 1000 / 60);

        const now = Date.now();
        const pulseFactor = 1 + Math.sin(now * PULSE_SPEED) * PULSE_AMPLITUDE;

        if (mouse.x > -9000) {
            mouseLight.position.x += (mouse.x - mouseLight.position.x) * 0.1;
            mouseLight.position.y += (mouse.y - mouseLight.position.y) * 0.1;
            mouseLight.intensity = 1.5;
        }

        particles.forEach(p => {
            const dx = mouse.x - p.body.position.x;
            const dy = mouse.y - p.body.position.y;
            const dist = Math.sqrt(dx * dx + dy * dy);

            if (mouse.x > -9000 && dist < ATTRACTION_RADIUS && dist > 1) {
                const normalX = dx / dist;
                const normalY = dy / dist;

                const deltaFromOrbit = dist - ORBIT_RADIUS;

                const forceMagnitude = deltaFromOrbit * FORCE_STRENGTH * p.body.mass;

                Body.applyForce(p.body, p.body.position, {
                    x: normalX * forceMagnitude,
                    y: normalY * forceMagnitude
                });
            }

            p.mesh.position.x = p.body.position.x;
            p.mesh.position.y = p.body.position.y;
            
            if (!p.mesh.position.z) p.mesh.position.z = (Math.random() - 0.5) * 50;
            
            p.mesh.rotation.z = p.body.angle;

            const currentScale = p.baseScale * pulseFactor;
            p.mesh.scale.set(currentScale, currentScale, currentScale);
        });

        renderer.render(scene, camera);
    }

    // --- Selection Logic ---
    function initSelection() {
        const arrow = document.querySelector('.arrow-line');
        const titleParts = document.querySelectorAll('.title-part');
        const groupInputs = document.querySelectorAll('.form-group-id');
        
        function moveArrowTo(el) {
            if (!arrow || !el) return;
            const r = el.getBoundingClientRect();
            const c = el.parentElement.getBoundingClientRect();
            arrow.style.top = `${r.top + r.height / 2 - c.top}px`;
        }

        const activeGroup = document.querySelector('.title-part.active');
        if (activeGroup) setTimeout(() => moveArrowTo(activeGroup), 100);

        titleParts.forEach(part => {
            part.addEventListener('click', () => {
                titleParts.forEach(p => p.classList.remove('active'));
                part.classList.add('active');
                moveArrowTo(part);
                const gid = part.dataset.groupId;
                groupInputs.forEach(input => input.value = gid);
            });
        });

        const numbers = document.querySelectorAll('.number');
        const courseArrow = document.querySelector('.course-arrow');
        const courseInputs = document.querySelectorAll('.form-course');

        function moveCourseArrow(el) {
            if (!courseArrow || !el) return;
            const r = el.getBoundingClientRect();
            const c = el.parentElement.getBoundingClientRect();
            courseArrow.style.left = `${r.left + r.width / 2 - c.left - 10}px`;
        }

        const activeCourse = document.querySelector('.number.active');
        if (activeCourse) setTimeout(() => moveCourseArrow(activeCourse), 100);

        numbers.forEach(num => {
            num.addEventListener('click', () => {
                numbers.forEach(n => n.classList.remove('active'));
                num.classList.add('active');
                moveCourseArrow(num);
                const cval = num.dataset.course;
                courseInputs.forEach(input => input.value = cval);
            });
        });

        window.addEventListener('resize', () => {
            const g = document.querySelector('.title-part.active');
            const c = document.querySelector('.number.active');
            if (g) moveArrowTo(g);
            if (c) moveCourseArrow(c);
        });
    }

    function initAll() {
        init();
        initSelection();
    }

    document.addEventListener("turbo:load", initAll);
    if (document.readyState === "complete" || document.readyState === "interactive") {
        initAll();
    } else {
        document.addEventListener("DOMContentLoaded", initAll);
    }
})();
</script>